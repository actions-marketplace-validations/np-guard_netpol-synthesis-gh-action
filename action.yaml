name: 'K8s NetworkPolicy Auto-Synthesis'
description: 'An action to automatically synthesize K8s NetworkPolicies, permitting only the connections your application requires and nothing more'
author: 'shift-left-netconfig project'

inputs:
  netpolYamlPath:
    description: 'A relative path in the source repository into which the resulting NetworkPolicies yaml will be written'
    required: false
    default: 'release/netpols.yaml'

runs:
  using: 'composite'
  steps:
    - uses: actions/checkout@v2
      with:
        path: repo
    - shell: sh
      run: |
        mkdir -p ${{ github.workspace }}/artifacts
        chmod a+rw ${{ github.workspace }}/artifacts
    - name: Analyze
      uses: docker://ghcr.io/shift-left-netconfig/net-top-analyzer@sha256:bd40a99fdbd293040a66166abd978bb806e17bf991998ba83fe06bac77e63a06
      with:
        args: -dirpath  /github/workspace/repo -commitid ${{ github.sha }} -giturl ${{ env.GITHUB_SERVER_URL }}/${{ github.repository }} -gitbranch ${{ github.ref }} -outputfile /github/workspace/artifacts/app-net-top.json
    - name: Synthesize
      uses: docker://ghcr.io/shift-left-netconfig/netpol-synth@sha256:2f8e41357a17ab07e61555b43314b26de713eb0dd46abbc16349168402425d16
      with:
        args: /github/workspace/artifacts/app-net-top.json -o /github/workspace/artifacts/netpols.yaml
    - name:  Upload Netpols Yaml
      uses: actions/upload-artifact@v2
      with:
        name: netpols.yaml
        path: ${{ github.workspace }}/artifacts/netpols.yaml
    - name:  Upload App network topology
      uses: actions/upload-artifact@v2
      with:
        name: app-net-top.json
        path: ${{ github.workspace }}/artifacts/app-net-top.json
    - name: Commit changes
      shell: sh
      run: |
        cd ${{ github.workspace }}/repo
        mkdir -p $( dirname ${{ inputs.netpolYamlPath }} )
        cp ${{ github.workspace }}/artifacts/netpols.yaml ${{ inputs.netpolYamlPath }}
        git config user.name ${{ github.actor }}
        git config user.email '${{ github.actor }}@users.noreply.github.com'
        git add ${{ github.workspace }}/repo/${{ inputs.netpolYamlPath }}
        git commit -m"adding network policies to enforce minimal connectivity"
    - name: Open PR
      uses: peter-evans/create-pull-request@v3
      with:
        path: repo
        title: Automatic updates to NetworkPolicies
        branch: update-netpols
        branch-suffix: timestamp
