name: 'K8s NetworkPolicy Auto-Synthesis'
description: 'An action to automatically synthesize K8s NetworkPolicies, permitting only the connections your application requires and nothing more'
author: 'shift-left-netconfig project'

inputs:
  corporate-policies:
    description: A list of space-separated corporate policy files to use
    required: false

outputs:
  netpols:
    description: Full path to the synthesized NetworkPolicies yaml (under the workflow's GitHub workspace)
    value: ${{ steps.set-outputs.outputs.netpols }}
  topology:
    description: Full path to the topology-analysis output (under the workflow's GitHub workspace)
    value: ${{ steps.set-outputs.outputs.topology }}

runs:
  using: 'composite'
  steps:
    - shell: sh
      run: |
        mkdir -p ${{ github.workspace }}/artifacts
        chmod a+rw ${{ github.workspace }}/artifacts
    - name: Analyze
      uses: docker://ghcr.io/shift-left-netconfig/net-top-analyzer@sha256:bd40a99fdbd293040a66166abd978bb806e17bf991998ba83fe06bac77e63a06
      with:
        args: -dirpath  /github/workspace -commitid ${{ github.sha }} -giturl ${{ env.GITHUB_SERVER_URL }}/${{ github.repository }} -gitbranch ${{ github.ref }} -outputfile /github/workspace/artifacts/app-net-top.json
    - name: Set -b flag
      id: add-b-flag
      shell: bash
      run: |
        for policy in ${{ inputs.corporate-policies }}
        do
          export POLICIES_WITH_B="-b $policy $POLICIES_WITH_B"
        done
        echo "::set-output name=policies-with-b::$(echo $POLICIES_WITH_B)"
    - name: Synthesize
      uses: docker://ghcr.io/shift-left-netconfig/netpol-synth@sha256:148e371fb40fd24ea924c1c32c969481f27808171dd901dd60141bd9f2f87b76
      with:
        args: /github/workspace/artifacts/app-net-top.json -o /github/workspace/artifacts/netpols.yaml ${{ steps.add-b-flag.outputs.policies-with-b }}
    - name: Set outputs
      id: set-outputs
      shell: bash
      run: |
        echo "::set-output name=netpols::$(echo ${{ github.workspace }}/artifacts/netpols.yaml)"
        echo "::set-output name=topology::$(echo ${{ github.workspace }}/artifacts/app-net-top.json)"
